variables:
  BUILD_ARTEFACT: "*.jar"
  BUILD_DIRECTORY: "build"
  BUILD_CACHE_KEY: "gradle-cache"

gradle-build:
  stage: build

  image: gradle:7.5.1-jdk17-alpine

  before_script:
    - export GRADLE_USER_HOME="$(pwd)/gradle-cache"

  cache:
    key:
      files:
        - gradle/wrapper/gradle-wrapper.properties
      prefix: $BUILD_CACHE_KEY
    paths:
      - gradle-cache/caches/
      - gradle-cache/notifications/
      - .sonar/cache
    policy: pull-push

  variables:
    GRADLE_OPTS: "-Dorg.gradle.daemon=false"

  script:
    - gradle --build-cache build
    - if [[ $CI_COMMIT_TITLE !~ "/^Merge\sbranch\s\W(hotfix|revert)[-\/].+/" ]]; then gradle check; fi
    - if [[ ${SONAR_PROJECT_KEY} ]]; then gradle sonarqube --stacktrace; fi

  artifacts:
    paths:
      - $BUILD_DIRECTORY/libs/$BUILD_ARTEFACT
    expire_in: 1 day

  tags:
    - builds
    - staging

  rules:
    - if: $REDEPLOY_API == "true"
      when: never
    - if: '$CI_COMMIT_REF_SLUG == $CI_DEFAULT_BRANCH'
